<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="voc">
	<resultMap id="CustVoiceVO" type="kr.co.realty.data.voc.vo.CustVoiceVO">
		<result property = "custVoiceSeq"	column="CUST_VOICE_SEQ"/>
		<result property = "bldInfoSeq"		column="BLD_INFO_SEQ"/>
		<result property = "custTitle"			column="CUST_TITLE"/>
		<result property = "custCate"			column="CUST_CATE"/>
		<result property = "custField"			column="CUST_FIELD"/>
		<result property = "custName"		column="CUST_NAME"/>
		<result property = "custPhone"		column="CUST_PHONE"/>
		<result property = "custEmail"		column="CUST_EMAIL"/>
		<result property = "contents"			column="CONTENTS"/>
		<result property = "custPW"			column="CUST_PW"/>
		<result property = "regDate"			column="REG_DATE"/>
		<result property = "strRegDate"		column="STR_REG_DATE"/>
		<result property = "isQR"				column="IS_QR"/>
		<result property = "isReply"			column="IS_REPLY"/>
		<result property = "isTolk"				column="IS_TOLK"/>
		<result property = "isUse"				column="IS_USE"/>
		<result property = "hitCount"			column="HIT_COUNT"/>
		<result property = "bldName"			column="BLD_NAME"/>
		<result property = "bldZone"			column="BLD_ZONE" />
		<result property = "bldDivision"		column="BLD_DIVISION" />
		<result property = "custFieldname"	column="CUST_FIELD_NAME"/>
		<result property = "custCateName"	column="CUST_CATE_NAME"/>
		<result property = "cnt"				column="CNT"/>
		
	</resultMap>	
	
	<resultMap id="CustVoiceReplyVO" type="kr.co.realty.data.voc.vo.CustVoiceReplyVO">
		<result property = "custVoiceReplySeq"	column="CUST_VOICE_REPLY_SEQ"/>
		<result property = "custVoiceSeq"			column="CUST_VOICE_SEQ"/>
		<result property = "admID"					column="ADM_ID"/>
		<result property = "replyType"				column="REPLY_TYPE"/>
		<result property = "replyContents"			column="REPLY_CONTENTS"/>
		<result property = "regDate"					column="REG_DATE"/>
		<result property = "admName"                 column="ADM_NAME" />
		<result property = "departmentName"       column="DEPARTMENT_NAME" />
	</resultMap>
	
	<resultMap id="CustVoiceFileVO" type="kr.co.realty.data.voc.vo.CustVoiceFileVO">
		<result property = "custVoiceFileSeq"	column="CUST_VOICE_FILE_SEQ"/>
		<result property = "custVoiceType"		column="CUST_VOICE_TYPE"/>
		<result property = "custVoiceSeq"		column="CUST_VOICE_SEQ"/>
		<result property = "fileType"				column="FILE_TYPE"/>
		<result property = "fileOrgnm"			column="FILE_ORGNM"/>
		<result property = "fileSavenm"			column="FILE_SAVENM"/>
		<result property = "filePath"				column="FILE_PATH"/>
		<result property = "fileSize"				column="FILE_SIZE"/>
		<result property = "fileFormName"		column="FILE_FORM_NAME"/>
	</resultMap>	
	
	 <insert id="insertForCustVoice" parameterType="CustVoiceVO" useGeneratedKeys="true" keyProperty="CUST_VOICE_SEQ">
     	<selectKey keyProperty="custVoiceSeq" resultType="int" order="BEFORE">
			SELECT CUST_VOICE_T_SEQ.NEXTVAL FROM DUAL
		</selectKey> 
          INSERT INTO 
          	CUST_VOICE ( 
			CUST_VOICE_SEQ
			,BLD_INFO_SEQ
			,CUST_TITLE
			,CUST_CATE
			,CUST_FIELD
			,CUST_NAME
			,CUST_PHONE
			,CUST_EMAIL
			,CONTENTS
			,CUST_PW
			,REG_DATE
			,IS_QR
			,HIT_COUNT
			,IS_REPLY
			,IS_TOLK
			,IS_USE
          ) VALUES ( 
                #{custVoiceSeq,jdbcType=INTEGER}
                ,#{bldInfoSeq,jdbcType=INTEGER}				
				,#{custTitle,jdbcType=VARCHAR}
				,#{custCate,jdbcType=VARCHAR}
				,#{custField,jdbcType=VARCHAR}
				,#{custName,jdbcType=VARCHAR}
				,#{custPhone,jdbcType=VARCHAR}
				,#{custEmail,jdbcType=VARCHAR}
				,#{contents,jdbcType=VARCHAR}
				,#{custPW,jdbcType=VARCHAR}
				,SYSDATE
				,#{isQR,jdbcType=VARCHAR}
				,0
				,'N'
				,'N'
				,'N'
          ) 
    </insert>
    
   	<insert id="insertForCustVoiceFile" parameterType="CustVoiceFileVO" >
         INSERT INTO 
         	CUST_VOICE_FILE (
				CUST_VOICE_FILE_SEQ
				,CUST_VOICE_TYPE
				,CUST_VOICE_SEQ
				,FILE_TYPE
				,FILE_ORGNM
				,FILE_SAVENM
				,FILE_PATH
				,FILE_SIZE
				,FILE_FORM_NAME
         ) VALUES (
               CUST_VOICE_FILE_T_SEQ.NEXTVAL
            ,#{custVoiceType,jdbcType=VARCHAR}
			,#{custVoiceSeq,jdbcType=INTEGER}
			,#{fileType,jdbcType=VARCHAR}								
			,#{fileOrgnm,jdbcType=VARCHAR}
			,#{fileSavenm,jdbcType=VARCHAR}
			,#{filePath,jdbcType=VARCHAR}
			,#{fileSize,jdbcType=VARCHAR}
			,#{fileFormName,jdbcType=VARCHAR}
         ) 
    </insert> 
    

	<select id="selectCountListForCustVoiceList"  parameterType="SearchVO" resultType="integer">	
		SELECT
			COUNT(t1.CUST_VOICE_SEQ)			
		FROM CUST_VOICE t1
		LEFT OUTER JOIN BLD_INFO t2 ON t1.BLD_INFO_SEQ = t2.BLD_INFO_SEQ
		LEFT OUTER JOIN BLD_MANAGER t3 ON t1.BLD_INFO_SEQ = t3.BLD_INFO_SEQ
		WHERE 1=1
		<if test=" isUse != null and isUse != '' ">
			AND t1.IS_USE=#{isUse}
		</if>		
		<if test="arrCustCate != null and arrCustCate != '' ">
			AND t1.CUST_CATE IN
	        <foreach collection="arrCustCate" item="type"  open="(" close=")" separator=",">
	            #{type}
	        </foreach>
		</if>
		
		<if test="arrCustField != null and arrCustField != '' ">
			AND t1.CUST_FIELD IN
	        <foreach collection="arrCustField" item="type"  open="(" close=")" separator=",">
	            #{type}
	        </foreach>
		</if>
		
		<if test="searchText != null and searchText != ''">
			<if test="searchType == 's_title'">
				AND (CUST_TITLE LIKE '%'||#{searchText}||'%')
			</if>
			<if test="searchType == 's_name'">
				AND (CUST_NAME LIKE '%'||#{searchText}||'%')
			</if>	
			<if test="searchType == 's_contents'">
				AND (CONTENTS LIKE '%'||#{searchText}||'%')
			</if>			
		</if>
		<if test="searchFromDate != null and searchFromDate != ''">
			AND t1.REG_DATE <![CDATA[>=]]> TO_DATE(#{searchFromDate},'YYYY-MM-DD')
		</if>
		<if test="searchToDate != null and searchToDate != ''">
			AND t1.REG_DATE <![CDATA[<=]]> TO_DATE(#{searchToDate},'YYYY-MM-DD')
		</if>		
		<if test=" bldZone != null and bldZone != '' ">
			AND t2.BLD_ZONE = #{bldZone,jdbcType=INTEGER}
		</if>
		<if test=" bldDivision != null and bldDivision != '' ">
			AND t2.BLD_DIVISION = #{bldDivision,jdbcType=INTEGER}
		</if>
		<if test=" bldInfoSeq != null and bldInfoSeq != '' ">
			AND t2.BLD_INFO_SEQ = #{bldInfoSeq,jdbcType=INTEGER}
		</if>
		<if test=" admID != null and admID != '' ">			
			AND ((T3.PMER = #{admID,jdbcType=VARCHAR}) OR (T3.CS_MANAGER = #{admID,jdbcType=VARCHAR}) OR (T3.PLACE_MANAGER = #{admID,jdbcType=VARCHAR}))
		</if>
	</select>
	
	<select id="selectListForCustVoiceAlert" resultMap="CustVoiceVO">
	SELECT
		BLD_INFO_SEQ
		, COUNT(BLD_INFO_SEQ) AS CNT
		, LISTAGG('<![CDATA[<p style="margin:5px 0 0; padding:0;">]]>'||TO_CHAR(REG_DATE,'(YYYY-MM-DD)')||'  '||CUST_TITLE, '<![CDATA[</p>]]>') WITHIN GROUP(ORDER BY REG_DATE) AS CUST_TITLE
	FROM CUST_VOICE
		WHERE IS_ALERT IS NULL
		AND REG_DATE <![CDATA[<]]> SYSDATE-1
		GROUP BY BLD_INFO_SEQ
	</select>
	
	<select id="selectListForCustVoice"  parameterType="SearchVO" resultMap="CustVoiceVO">
	SELECT * FROM (	
		SELECT
			t1.CUST_VOICE_SEQ
			,t1.BLD_INFO_SEQ
			,t1.CUST_TITLE
			,t1.CUST_CATE
			,t1.CUST_FIELD
			,t1.CUST_NAME
			,t1.CUST_PHONE
			,t1.CUST_EMAIL
			,t1.CONTENTS
			,t1.CUST_PW
			,t1.REG_DATE
			,t1.IS_QR
			,t1.HIT_COUNT
			,t1.IS_REPLY
			,t1.IS_TOLK
			,t1.IS_USE
			,t2.BLD_NAME
			,ROW_NUMBER() OVER( ORDER BY t1.REG_DATE DESC, t1.CUST_VOICE_SEQ DESC) AS RNUM
		FROM CUST_VOICE t1
		LEFT OUTER JOIN BLD_INFO t2 ON t1.BLD_INFO_SEQ = t2.BLD_INFO_SEQ
		LEFT OUTER JOIN BLD_MANAGER t3 ON t1.BLD_INFO_SEQ = t3.BLD_INFO_SEQ
		WHERE 1=1
		<if test=" isUse != null and isUse != '' ">
			AND t1.IS_USE=#{isUse}
		</if>		
		<if test="arrCustCate != null and arrCustCate != '' ">
			AND t1.CUST_CATE IN
	        <foreach collection="arrCustCate" item="type"  open="(" close=")" separator=",">
	            #{type}
	        </foreach>
		</if>
		
		<if test="arrCustField != null and arrCustField != '' ">
			AND t1.CUST_FIELD IN
	        <foreach collection="arrCustField" item="type"  open="(" close=")" separator=",">
	            #{type}
	        </foreach>
		</if>
		
		<if test="searchText != null and searchText != ''">
			<if test="searchType == 's_title'">
				AND (CUST_TITLE LIKE '%'||#{searchText}||'%')
			</if>
			<if test="searchType == 's_name'">
				AND (CUST_NAME LIKE '%'||#{searchText}||'%')
			</if>	
			<if test="searchType == 's_contents'">
				AND (CONTENTS LIKE '%'||#{searchText}||'%')
			</if>			
		</if>
		<if test="searchFromDate != null and searchFromDate != ''">
			AND t1.REG_DATE <![CDATA[>=]]> TO_DATE(#{searchFromDate},'YYYY-MM-DD')
		</if>
		<if test="searchToDate != null and searchToDate != ''">
			AND t1.REG_DATE <![CDATA[<=]]> TO_DATE(#{searchToDate},'YYYY-MM-DD')
		</if>		
		<if test=" bldZone != null and bldZone != '' ">
			AND t2.BLD_ZONE = #{bldZone,jdbcType=INTEGER}
		</if>
		<if test=" bldDivision != null and bldDivision != '' ">
			AND t2.BLD_DIVISION = #{bldDivision,jdbcType=INTEGER}
		</if>
		<if test=" bldInfoSeq != null and bldInfoSeq != '' ">
			AND t2.BLD_INFO_SEQ = #{bldInfoSeq,jdbcType=INTEGER}
		</if>
		<if test=" admID != null and admID != '' ">			
			AND ((T3.PMER = #{admID,jdbcType=VARCHAR}) OR (T3.CS_MANAGER = #{admID,jdbcType=VARCHAR}) OR (T3.PLACE_MANAGER = #{admID,jdbcType=VARCHAR}))
		</if>
		)T WHERE 
				RNUM BETWEEN ((#{pageIndex}-1) * #{pageCount}) + 1 AND ((#{pageIndex}-1) * #{pageCount}) + #{pageCount}
	</select>
	
	<select id="selectOneForCustVoice"  parameterType="CustVoiceVO" resultMap="CustVoiceVO">
		SELECT
			t1.CUST_VOICE_SEQ
			,t1.BLD_INFO_SEQ
			,t1.CUST_TITLE
			,t1.CUST_CATE
			,(SELECT CODE_NAME FROM COMMCODE WHERE CODE_SEQ=t1.CUST_CATE) AS CUST_CATE_NAME
			,t1.CUST_FIELD
			,(SELECT CODE_NAME FROM COMMCODE WHERE CODE_SEQ=t1.CUST_FIELD) AS CUST_FIELD_NAME
			,t1.CUST_NAME
			,t1.CUST_PHONE
			,t1.CUST_EMAIL
			,t1.CONTENTS
			,t1.CUST_PW
			,t1.REG_DATE
			,TO_CHAR(t1.REG_DATE,'YYYYHHDDHH24MISS') AS STR_REG_DATE
			,t1.IS_QR
			,t1.HIT_COUNT
			,t1.IS_REPLY
			,t1.IS_TOLK
			,t1.IS_USE
			,t2.BLD_NAME			
			,t2.BLD_ZONE AS BLD_ZONE
            ,t2.BLD_DIVISION AS BLD_DIVISION						
		FROM CUST_VOICE t1
		LEFT OUTER JOIN BLD_INFO t2 ON t1.BLD_INFO_SEQ = t2.BLD_INFO_SEQ		
		WHERE t1.CUST_VOICE_SEQ = #{custVoiceSeq}
	</select>
	
	<select id="selectOneForCustVoiceFile"  parameterType="CustVoiceFileVO" resultMap="CustVoiceFileVO">
		SELECT
			CUST_VOICE_FILE_SEQ
			,CUST_VOICE_TYPE
			,CUST_VOICE_SEQ
			,FILE_TYPE
			,FILE_ORGNM
			,FILE_SAVENM
			,FILE_PATH
			,FILE_SIZE
			,FILE_FORM_NAME					
		FROM CUST_VOICE_FILE				
		WHERE CUST_VOICE_TYPE = #{custVoiceType}
			AND CUST_VOICE_SEQ = #{custVoiceSeq}
	</select>
	
	
	<insert id="insertForCustVoiceReply" parameterType="CustVoiceReplyVO" useGeneratedKeys="true" keyProperty="CUST_VOICE_REPLY_SEQ">
     	<selectKey keyProperty="custVoiceReplySeq" resultType="int" order="BEFORE">
			SELECT CUST_VOICE_REPLY_T_SEQ.NEXTVAL FROM DUAL
		</selectKey>
         INSERT INTO 
         	CUST_VOICE_REPLY (
				CUST_VOICE_REPLY_SEQ
				,CUST_VOICE_SEQ
				,ADM_ID
				,REPLY_TYPE
				,REPLY_CONTENTS
				,REG_DATE
         ) VALUES (
            #{custVoiceReplySeq}            
			,#{custVoiceSeq,jdbcType=INTEGER}
			,#{admID,jdbcType=VARCHAR}								
			,#{replyType,jdbcType=VARCHAR}
			,#{replyContents,jdbcType=VARCHAR}
			,SYSDATE
         ) 
    </insert>
    
    <update id="updateForCustVoiceHitCount" parameterType="CustVoiceVO">
		UPDATE CUST_VOICE SET
			HIT_COUNT=HIT_COUNT+1			
		WHERE CUST_VOICE_SEQ = #{custVoiceSeq,jdbcType=INTEGER}
    </update>
    
    <update id="updateOneForCustVoiceReplyFlag" parameterType="CustVoiceVO">
		UPDATE CUST_VOICE SET
			IS_REPLY='Y'
			,IS_ALERT='Y'
		WHERE CUST_VOICE_SEQ = #{custVoiceSeq,jdbcType=INTEGER}
    </update>
    
     <update id="updateOneForCustVoiceTalkTalkFlag" parameterType="CustVoiceVO">
		UPDATE CUST_VOICE SET
			IS_TOLK='Y'					
		WHERE CUST_VOICE_SEQ = #{custVoiceSeq,jdbcType=INTEGER}
    </update>
    
    <update id="updateForCustVoiceIsUse" parameterType="CustVoiceVO">
		UPDATE CUST_VOICE SET
			IS_USE=#{isUse,jdbcType=VARCHAR}
		WHERE CUST_VOICE_SEQ = #{custVoiceSeq,jdbcType=INTEGER}
    </update>
    
	<update id="updateForCustVoiceIsAlert" parameterType="CustVoiceVO">
		UPDATE CUST_VOICE SET
			IS_ALERT='Y'
		WHERE BLD_INFO_SEQ = #{bldInfoSeq,jdbcType=INTEGER}
    </update>
    
    
    <select id="selectOneForCustVoiceReply"  parameterType="CustVoiceReplyVO" resultMap="CustVoiceReplyVO">
		SELECT
			t1.CUST_VOICE_REPLY_SEQ
			,t1.CUST_VOICE_SEQ
			,t1.ADM_ID
			,t1.REPLY_TYPE
			,t1.REPLY_CONTENTS
			,t1.REG_DATE
			,t2.ADM_NAME
			,t2.DEPARTMENT_NAME					
		FROM CUST_VOICE_REPLY t1		 
		LEFT OUTER JOIN ADM_MEMBER t2 ON t1.ADM_ID=t2.ADM_ID		
		WHERE t1.CUST_VOICE_SEQ = #{custVoiceSeq}
	</select>
    
	<update id="updateForCustVoiceReply" parameterType="CustVoiceReplyVO">
		UPDATE CUST_VOICE_REPLY SET
			REPLY_TYPE=#{replyType,jdbcType=VARCHAR}
			,REPLY_CONTENTS=#{replyContents,jdbcType=VARCHAR}			
		WHERE CUST_VOICE_SEQ = #{custVoiceSeq,jdbcType=INTEGER}
    </update>
    
    <delete id="deleteCustVoiceFile" parameterType="CustVoiceFileVO">     	
		DELETE FROM CUST_VOICE_FILE WHERE CUST_VOICE_TYPE = #{custVoiceType,jdbcType=VARCHAR} AND CUST_VOICE_SEQ = #{custVoiceSeq,jdbcType=INTEGER}
    </delete>
    
    <update id="updateForCustVoiceManager" parameterType="CustVoiceVO">
		UPDATE CUST_VOICE SET
			BLD_INFO_SEQ=#{bldInfoSeq,jdbcType=INTEGER}					
		WHERE CUST_VOICE_SEQ = #{custVoiceSeq,jdbcType=INTEGER}
    </update>			
</mapper>